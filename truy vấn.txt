USE QLKQSV
GO
--Cho biết điểm thi các môn của sinh viên có mã số sinh viên là “15001”.
SELECT MSSV, MAMT ,DIEM
FROM THI
WHERE MSSV='15001'

--Cho biết mã giảng viên, tên của các giảng viên là trưởng khoa hoặc quản lý chuyên ngành.
--Quản lý 
SELECT MAGV, GIANGVIEN.HOTEN
FROM GIANGVIEN, CHUYENNGANH 
WHERE CHUYENNGANH.MA_QL = GIANGVIEN.MAGV
--Trưởng Khoa
SELECT MAGV, GIANGVIEN.HOTEN
FROM GIANGVIEN, KHOA
WHERE KHOA.MATRUONGKHOA = MAGV

--Cho biết mã khoa, tên khoa và tên các giảng viên làm trưởng khoa đó.
SELECT K.MAKHOA, K.TENKHOA, GV.HOTEN
FROM GIANGVIEN  AS GV, KHOA AS K
WHERE K.MATRUONGKHOA = GV.MAGV

--Cho biết mã giảng viên, họ tên và tên khoa của giảng viên đó đang làm việc.
SELECT GIANGVIEN.MAGV, GIANGVIEN.HOTEN, KHOA.TENKHOA
FROM GIANGVIEN, LAMVIEC, KHOA
WHERE GIANGVIEN.MAGV = LAMVIEC.MAGV AND KHOA.MAKHOA = LAMVIEC.MAKHOA

--In ra danh sách các giảng viên không thuộc khoa CNTT
SELECT GV.MAGV, GV.HOTEN
FROM LAMVIEC AS L
JOIN GIANGVIEN AS GV ON L.MAGV = GV.MAGV
WHERE MAKHOA NOT LIKE 'CNTT'

--Tìm các sinh viên có họ là “Nguyễn”.
SELECT *
FROM SINHVIEN
WHERE HOTEN LIKE N'Nguyễn%';

--Tìm các sinh viên có họ là “Nguyễn” và đang học tại khoa CNTT.
SELECT S.MSSV, S.HOTEN, K.MAKHOA FROM SINHVIEN AS S
JOIN LOP AS L ON S.MALOP = L.MALOP
JOIN CHUYENNGANH AS C ON L.MACN = C.MACN
JOIN KHOA AS K ON K.MAKHOA = C.MAKHOA
WHERE K.MAKHOA = 'CNTT' AND S.HOTEN LIKE N'Nguyễn%';

--Cho biết sinh viên nào đang sử dụng nhiều hơn một số điện thoại
SELECT V.MSSV, V.HOTEN, COUNT(S.SDT) AS SDT_COUNT
FROM SINHVIEN_SDT AS S
JOIN SINHVIEN AS V ON S.MSSV = V.MSSV
GROUP BY V.MSSV, V.HOTEN
HAVING COUNT(S.SDT) > 1;


--Cho biết danh sách các sinh viên trong lớp có mã là “KTPM01”.
SELECT *
FROM  SINHVIEN
WHERE MALOP = 'KTPM01'

--Cho biết các sinh viên thuộc chuyên ngành có mã là KTPM....................
SELECT MSSV, HOTEN, CHUYENNGANH.MACN
FROM CHUYENNGANH, SINHVIEN, LOP 
WHERE CHUYENNGANH.MACN ='KTPM' AND LOP.MACN = CHUYENNGANH.MACN AND SINHVIEN.MALOP = LOP.MALOP

--Cho biết thông tin các sinh viên nam có địa chỉ tại HCM.
SELECT MSSV, HOTEN, TP, GIOITINH
FROM SINHVIEN
WHERE  TP = N'TP. Hồ Chí Minh' AND GIOITINH ='Nam'

--Cho biết thông tin các lớp có số lượng sinh viên trên 45.
SELECT *
FROM LOP
WHERE SISO > 45 

--Cho biết mã lớp, sĩ số lớp. Kết quả trả về sắp xếp sĩ số lớp giảm dần.
SELECT MALOP, SISO
FROM LOP
ORDER BY SISO DESC;

--Cho biết lớp nào có số lượng sinh viên ít nhất.
SELECT TOP 1 MALOP, SISO
FROM LOP
ORDER BY SISO ASC;

--Cho biết khoa nào có số lượng sinh viên nhiều nhất.
SELECT TOP 1 K.MAKHOA, K.TENKHOA, COUNT(SV.MSSV) AS SoLuongSinhVien
FROM KHOA AS K
JOIN CHUYENNGANH AS C ON K.MAKHOA = C.MAKHOA
JOIN LOP AS L ON  L.MACN = C.MACN
JOIN SINHVIEN AS SV ON L.MALOP = SV.MALOP
GROUP BY K.MAKHOA, K.TENKHOA
ORDER BY SoLuongSinhVien DESC;


--Cho biết các sinh viên có điểm tất cả các môn thi đều lớn hơn hoặc bằng 8.
SELECT DISTINCT SV.MSSV, SV.HOTEN
FROM SINHVIEN AS SV
WHERE SV.MSSV NOT IN (
    SELECT T.MSSV
    FROM THI AS T
    WHERE T.DIEM < 8
);




--Cho biết điểm trung bình môn thi của các sinh viên. .................................................................
SELECT MAMT ,AVG(DIEM) FROM THI AS T
GROUP BY MAMT 


--Ứng với mỗi môn thi, tìm sinh viên có điểm cao nhất và thấp nhất.....................................................
SELECT MAMT, MSSV, 
       MAX(DIEM) AS Diem_Cao_Nhat, 
       MIN(DIEM) AS Diem_Thap_Nhat
FROM THI
GROUP BY MAMT, MSSV;


--Những môn thi nào mà sinh viên đều bị điểm thi dưới 5..................................................................
/*
ĐIỂM SINH VIÊN THUỘC MÔN N SO SÁNH NẾU TẤT CẢ ĐIỂM SINH VIÊN TRONG MÔN NÀY ĐỀU < 5......................................
*/
SELECT DISTINCT MAMT FROM THI
WHERE NOT EXISTS(SELECT DIEM  FROM THI
WHERE DIEM >= 5)

--Cho biết sinh viên nào có tổng điểm các môn thi là cao nhất
SELECT TOP 1 SV.MSSV, SV.HOTEN, SUM(T.DIEM) AS TONGDIEM
FROM SINHVIEN SV
JOIN THI T ON SV.MSSV = T.MSSV
GROUP BY SV.MSSV, SV.HOTEN
ORDER BY TONGDIEM DESC

--Cho biết có bao nhiêu sinh viên vắng thi.
SELECT COUNT(*) AS Số_Lượng_Sinh_Viên_Vắng_Thi
FROM THI
WHERE GHICHU =N'Vắng thi' OR DIEM = 0

--Cho biết có bao nhiêu sinh viên có ít nhất 1 bài thi bị điểm 0.
SELECT COUNT(DISTINCT T.MSSV) AS SoLuongSinhVien
FROM THI AS T
WHERE T.DIEM = 0;


--Cho biết những môn thi nào có sinh viên bị 0 điểm.
SELECT DISTINCT MAMT, DIEM
FROM THI
WHERE DIEM = 0

--Cho biết có bao nhiêu sinh viên hoàn tất đầy đủ tất cả các bài thi
SELECT COUNT(DISTINCT T.MSSV)
FROM THI AS T
JOIN SINHVIEN AS SV ON T.MSSV = SV.MSSV
WHERE NOT EXISTS (
    SELECT 1
    FROM THI AS T
    WHERE T.MSSV = SV.MSSV AND T.DIEM = 0
	);





--Cho biết thông tin các trưởng khoa nhận chức từ đầu năm 2015 đến hết năm 2018.............................

--Cho biết thông tin các sinh viên có điểm thi tất cả các môn đều lớn hơn hoặc bằng 9.
SELECT DISTINCT SV.MSSV, SV.HOTEN
FROM SINHVIEN AS SV
WHERE SV.MSSV NOT IN (
    SELECT T.MSSV
    FROM THI AS T
    WHERE T.DIEM < 9
);

--Xuất ra danh sách sinh viên có điểm trung bình > điểm trung bình của tất cả sinh viên thuộc khoa CNTT
SELECT SV.MSSV, SV.HOTEN, AVG(T.DIEM) AS 'Điểm trung bình'
FROM SINHVIEN AS SV
JOIN THI AS T ON T.MSSV = SV.MSSV
JOIN LOP AS L ON L.MALOP = SV.MALOP
JOIN CHUYENNGANH AS C ON C.MACN = L.MACN
JOIN KHOA AS K ON K.MAKHOA = C.MAKHOA
WHERE C.MAKHOA = 'CNTT' 
GROUP BY SV.MSSV, SV.HOTEN
HAVING AVG(T.DIEM) > (
	SELECT AVG(T.DIEM)
	FROM SINHVIEN AS SV
	JOIN THI AS T ON T.MSSV = SV.MSSV
	JOIN LOP AS L ON L.MALOP = SV.MALOP
	JOIN CHUYENNGANH AS C ON C.MACN = L.MACN
	JOIN KHOA AS K ON K.MAKHOA = C.MAKHOA
	WHERE C.MAKHOA = 'CNTT' 
)


--Xuất ra thông tin của khoa có nhiều hơn 3 chuyên ngành.
SELECT K.MAKHOA, K.TENKHOA, COUNT(CN.MACN) AS SO_CHUYENNGANH
FROM KHOA K
JOIN CHUYENNGANH CN ON K.MAKHOA = CN.MAKHOA
GROUP BY K.MAKHOA, K.TENKHOA
HAVING COUNT(CN.MACN) > 3;


--Cho biết danh sách các chuyên ngành và tên của giảng viên quản lý chuyên ngành đó.
SELECT CN.MACN, CN.TENCN, GV.HOTEN AS TEN_GIANGVIEN_QUANLY
FROM CHUYENNGANH CN
JOIN GIANGVIEN GV ON CN.MA_QL = GV.MAGV;

--Cho biết thông tin các chuyên ngành và tên của người quản lý chuyên ngành, 
--đối với những chuyên ngành chưa biết giảng viên nào làm quản lý thì tại các cột
--cho biết mã và tên của người quản lý chuyên ngành mang giá trị rỗng (null).............................................
SELECT CN.MACN, CN.TENCN, COALESCE(GV.HOTEN, '') AS TEN_GIANGVIEN_QUANLY
FROM CHUYENNGANH CN
LEFT JOIN GIANGVIEN GV ON CN.MA_QL = GV.MAGV;


--Cho biết mã số sinh viên, họ tên, điểm của các sinh viên thi môn “Cơ sở dữ liệu”.
SELECT SV.MSSV, SV.HOTEN, T.DIEM
FROM SINHVIEN SV
JOIN THI T ON SV.MSSV = T.MSSV
JOIN MONTHI MT ON T.MAMT = MT.MAMT
WHERE MT.MAMT = 'CSDL';

--Cho biết những sinh viên có điểm trung bình lớn hơn hoặc bằng 5 và điểm thi môn “Cơ sở dữ liệu” lớn hơn 8.
SELECT SV.MSSV, SV.HOTEN, AVG(T.DIEM) AS DIEM_TRUNGBINH
FROM SINHVIEN SV
JOIN THI T ON SV.MSSV = T.MSSV
JOIN MONTHI MT ON T.MAMT = MT.MAMT
WHERE MT.MAMT = 'CSDL' AND T.DIEM > 8
GROUP BY SV.MSSV, SV.HOTEN
HAVING AVG(T.DIEM) >= 5 

--Lập bảng điểm môn “Cơ sở dữ liệu” của tất cả sinh viên khoa CNTT.
SELECT S.MSSV, S.HOTEN, M.TENMT, T.DIEM, C.MAKHOA  FROM SINHVIEN AS S
JOIN THI AS T ON S.MSSV = T.MSSV
JOIN MONTHI AS M ON T.MAMT = M.MAMT
JOIN LOP AS L ON S.MALOP = L.MALOP
JOIN CHUYENNGANH AS C ON L.MACN = C.MACN
WHERE C.MAKHOA = 'CNTT' AND M.MAMT = 'CSDL'

--Cho biết điểm thấp nhất, điểm cao nhất và điểm trung bình của bài thi môn “Cơ sở dữ liệu”.
SELECT MIN(T.DIEM) AS 'Điểm thấp nhất', MAX(T.DIEM) AS 'Điểm cao nhất', AVG(T.DIEM) AS 'Điểm trung bình'  FROM THI AS T 
JOIN MONTHI AS M ON T.MAMT = M.MAMT
WHERE M.MAMT = 'CSDL'


--Cho biết những sinh viên nào ở khoa CNTT bị điểm 0 do vắng thi (Mã sinh viên, họ tên).
SELECT K.MAKHOA, K.TENKHOA, S.MSSV, T.DIEM, T.GHICHU FROM SINHVIEN AS S
JOIN LOP AS L ON S.MALOP = L.MALOP
JOIN CHUYENNGANH AS C ON L.MACN = C.MACN 
JOIN KHOA AS K ON C.MAKHOA = K.MAKHOA
JOIN THI AS T ON S.MSSV = T.MSSV
WHERE K.MAKHOA = 'CNTT' AND T.DIEM = 0 AND T.GHICHU = N'Vắng thi'

--Cho biết những lớp có sinh viên vắng thi. Thông tin cần:Mã lớp, số lượng sinh viên vắng.
SELECT S.MALOP, COUNT(T.MSSV) AS 'Số lượng vắng' FROM SINHVIEN AS S
JOIN LOP AS L ON S.MALOP = L.MALOP
JOIN THI AS T ON T.MSSV = S.MSSV
WHERE T.GHICHU = N'Vắng thi'
GROUP BY S.MALOP



--Cho biết số lượng sinh viên của mỗi chuyên ngành.
SELECT L.MACN, C.TENCN, SUM(SISO) AS 'TỔNG SINH VIÊN' FROM LOP AS L
JOIN CHUYENNGANH AS C ON L.MACN = C.MACN
GROUP BY L.MACN, C.TENCN


--Cho biết chuyên ngành nào có nhiều sinh viên theo học nhất.
SELECT TOP 1 L.MACN, C.TENCN, SUM(SISO) AS SOLUONGSINHVIEN FROM LOP AS L
JOIN CHUYENNGANH AS C ON L.MACN = C.MACN
GROUP BY L.MACN, C.TENCN 



--Cho biết các sinh viên thuộc chuyên ngành có mã là KPDL và có điểm tất cả môn thi lớn hơn hoặc bằng 8.......................
SELECT S.MSSV, HOTEN, MCN.MACN, T.MAMT, T.DIEM FROM SINHVIEN AS S
JOIN THI AS T ON S.MSSV = T.MSSV
JOIN MON_CHUYENNGANH AS MCN ON T.MAMT = MCN.MAMT
WHERE MCN.MACN = 'KPDL' AND S.MSSV NOT IN (
		SELECT T.MSSV FROM THI AS T2
		WHERE T2.DIEM < 8
	);



--Mỗi khoa có bao nhiêu giảng viên (Mã khoa, tên bộ môn, số giảng viên ).
SELECT K.MAKHOA, K.TENKHOA, COUNT(L.MAGV) AS 'SỐ GIẢNG VIÊN'   FROM KHOA AS K
JOIN LAMVIEC AS L ON K.MAKHOA = L.MAKHOA
GROUP BY K.MAKHOA, K.TENKHOA


--Cập nhật tăng 0.5 điểm bài thi môn “Cơ sở dữ liệu” cho sinh viên có mã là “15001”.
UPDATE THI
SET DIEM = DIEM + 0.5
WHERE MSSV = '15001' AND MAMT = 'CSDL'; 